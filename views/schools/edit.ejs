<% layout('layouts/boilerplate') %>

<style>
    #map {
        height: 250px;
    }

    #geocoder {
        position: relative;
        width: 100%;
    }

    .mapboxgl-ctrl-geocoder {
        width: 100%;
        max-width: 100%;
    }

    #geocoder-city .mapboxgl-ctrl-geocoder:first-child {
        z-index: 1001;
    }

</style>

<link href="/css/form.css" rel="stylesheet">

<script src='https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.css' rel='stylesheet' />

<div class="pb-4">
    <div class="col-md-6 col-sm-12 m-auto mt-4 form-container">
        <%- include('../partials/flash') %>
        <!-- Load the `mapbox-gl-geocoder` plugin. -->
        <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
        <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">


        
        <!-- Head of the form -->
        <div>
            <a href="/school/<%= school._id %>" class="d-flex justify-content-end">
                <button type="button" class="btn-close" aria-label="Close"></button>
            </a>
            <h1 class="text-center pb-2 pt-2">Edit Preschool</h1>
            <!-- <div class="form-header">
                <div>
                    <button class="btn btn-primary btn-sm back-button hidden">Back</button>
                </div>
                <div class="step-container">
                    <div id="step-1" class="step active"><div class="step__circle">1</div><div class="step__text">General Info</div></div>
                    <div id="step-2" class="step"><div class="step__circle">2</div><div class="step__text">Preschool Details</div></div>

                </div>
            </div> -->
        </div>
        <hr>

        <!-- FORM DATA -->
        <form class="" action="/school/<%= school._id %>?_method=PUT" method="POST">
            
            <!-- Tabs - card switch -->
            <ul class="nav nav-pills nav-fill pb-3">
                <li class="nav-item" >
                    <button type="button" id="tab1" class="nav-link active">General Info</button>
                </li>
                <li class="nav-item ms-2" >
                    <button type="button" id="tab2" class="nav-link">Pricing & Amenities</button>
                </li>
            </ul>

            <!-- Card 1 - Start -->
            <div data-card="1" class="">
                <div class="row mb-3">
                    <label class="form-label">Preschool Type</label>
                    <div>
                    
                        <% for (const category of categories) { %>
                                <input type="checkbox" class="btn-check" name="school[category]" <%= school.category.indexOf(category.short) >= 0 ? 'checked' : '' %> value="<%= category.short %>" id="<%= category.name %>" autocomplete="off">
                                <label class="btn btn-outline-secondary mb-1" for="<%= category.name %>"><%= category.name %></label> 
                        <% } %>

                    </div>
                </div>

                <div class="row mb-3">
                    <div>
                        <label for="name" class="form-label">Preschool name</label>
                        <input name="school[title]" type="text" class="form-control" value="<%= school.title %>" id="name" placeholder="Preschool name">
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col">
                        <% var currentCountry = school.country.code %>
                        <label for="country" class="form-label">Country</label>
                        <select data-country-code="<%= school.country.code %>" name="school[country][code]" id="country" class="form-select">
                            <!-- <option selected="true" disabled="disabled" value="">Select your country</option> -->
                            <optgroup label="North America">
                                <option value="US">United States</option>
                                <option value="CA">Canada</option>
                            </optgroup>
                            
                            <optgroup label="Europe">
                                <option value="GB">United Kingdom</option>  
                                <option value="AT">Austria</option>
                                <option value="BE">Belgium</option>
                                <option value="CZ">Czech Republic</option>
                                <option value="FR">France</option>
                                <option value="DE">Germany</option>
                                <option value="GR">Greece</option>
                                <option value="HU">Hungary</option>
                                <option value="IT">Italy</option>
                                <option value="LI">Liechtenstein</option>
                                <option value="LU">Luxembourg</option>          
                                <option value="MC">Monaco</option>
                                <option value="NL">Netherlands</option>
                                <option value="PL">Poland</option>
                                <option value="PT">Portugal</option>        
                                <option value="SK">Slovakia</option>
                                <option value="SI">Slovenia</option>
                                <option value="ES">Spain</option>
                                <option value="UA">Ukraine</option>
                                <option value="DK">Denmark</option>
                                <option value="EE">Estonia</option>
                                <option value="FI">Finland</option>
                                <option value="IS">Iceland</option>
                                <option value="IE">Ireland</option>
                                <option value="NO">Norway</option>
                                <option value="SE">Sweden</option>
                                <option value="CH">Switzerland</option>
                            </optgroup>
                            
                            <optgroup label="Asia">
                                <option value="HK">Hong Kong</option>
                                <option value="ID">Indonesia</option>
                                <option value="JP">Japan</option>
                                <option value="KR">Korea, Republic of</option>
                                <option value="MY">Malaysia</option>
                                <option value="SG">Singapore</option>
                                <option value="TW">Taiwan</option>
                            </optgroup>
                            
                            <optgroup label="Australia / Oceania">
                                <option value="AU">Australia</option>
                                <option value="NZ">New Zealand</option>
                            </optgroup>
                        </select>  
                    </div>

                    <div class="col">
                        <label for="geocoder-city" class="form-label">City</label>
                        <div id="geocoder-city"></div>  
                        <!-- <input id="city-" class="form-control" name="school[city][name]" value="<%= school.city.name %>"> -->
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col">
                        <label for="geocoder-address" class="form-label">Address</label>
                        <div id="geocoder-address"></div>  
                    </div>
                </div>


                

                <!-- HIDDEN FIELDS -->
                <input type="hidden" id="_coordinates" name="school[geometry][coordinates]" value="<%= school.geometry.coordinates[0] + ',' + school.geometry.coordinates[1] %>">
                <input type="hidden" id="lat" name="school[lat]">
                <input type="hidden" id="long" name="school[long]">
                <input type="hidden" id="_fullAddress" name="school[context][fullAddress]" value="<%= school.context.fullAddress %>">
                <input type="hidden" id="_streetName" name="school[context][streetName]" value="<%= school.context.streetName %>">
                <input type="hidden" id="_streetNumber" name="school[context][streetNumber]" value="<%= school.context.streetNumber %>">
                <input type="hidden" id="_zip" name="school[context][zip]" value="<%= school.context.zip %>">
                <input type="hidden" id="_city" name="school[city][name]" value="<%= school.city.name %>">
                <input type="hidden" id="_cityCenterCoords" name="school[city][coordinates]" value="<%= school.city.coordinates %>">
                <input type="hidden" id="_bbox" name="school[city][bbox]" value="<%= school.city.bbox %>">
                <input type="hidden" id="_countryName" name="school[country][name]" value="<%= school.country.name %>">
                <input type="hidden" id="_region" name="school[context][region]" value="<%= school.context.region %>">
                <input type="hidden" id="_neighborhood" name="school[context][neighborhood]" value="<%= school.context.neighborhood %>">
                <input type="hidden" id="_locality" name="school[context][locality]" value="<%= school.context.locality %>">
                <input type="hidden" id="_district" name="school[context][district]" value="<%= school.context.district %>"> 
                <input type="hidden" id="_continent" name="school[context][continent][name]" value="<%= school.context.continent.name %>"> 

                <div id="map" class="mb-3"></div>
                <!-- <pre id="result"></pre> -->

                <div class="pt-2">
                    <h5>Specifics</h5>
                    <div class="row mb-3">
                        <div class="col">
                            <label for="email" class="form-label">Email address</label>
                            <input name="school[contact][email]" type="text" class="form-control" id="email" placeholder="Email address" value="<%= school.contact.email %>">  
                        </div>
                        <div class="col">
                            <label for="phone" class="form-label">Phone Number</label>
                            <input name="school[contact][phone]" type="text" class="form-control" id="phone" placeholder="Eg.+12012987481" value="<%= school.contact.phone %>">  
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label for="fb" class="form-label">Facebook</label>
                            <input name="school[contact][fb]" type="text" class="form-control" id="fb" placeholder="Facebook Page" value="<%= school.contact.fb %>">  
                        </div>
                        <div class="col">
                            <label for="ig" class="form-label">Instagram</label>
                            <input name="school[contact][ig]" type="text" class="form-control" id="ig" placeholder="Instagram Page" value="<%= school.contact.ig %>">  
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label for="www" class="form-label">Website</label>
                            <input name="school[contact][www]" type="text" class="form-control" id="www" placeholder="Eg. https://hogwarts.com" value="<%= school.contact.www %>">  
                        </div>
                        <div class="col">
                            <label for="manager" class="form-label">Owner/Manager Name</label>
                            <input name="school[contact][manager]" type="text" class="form-control" id="manager" placeholder="Owner/Manager Name" value="<%= school.contact.manager %>">  
                        </div>
                    </div>
                    <% if ((currentUser.role != 'admin') && (!school.owner)) { %>
                    <div class="row mb-3">
                        <h5>Are you the Owner/Manager</h5>
                        <div class="mb-3">
                            <input class="btn-check" type="radio" name="school[ownership][owner]" value="true" id="owner-true" <%= school.ownership.owner == true ? 'checked' : '' %> >
                            <label class="btn btn-outline-secondary" for="owner-true">Yes, I am</label>
                            <input class="btn-check" type="radio" name="school[ownership][owner]" value="false" id="owner-false" <%= school.ownership.owner == false ? 'checked' : '' %> >
                            <label class="btn btn-outline-secondary" for="owner-false">No, I'm not</label>
                        </div>
                    </div>
                    <% } %>
                </div>

                <!-- <div class="mb-3 text-end">
                    <button type="button" class="btn btn-primary next-step">Continue</button>
                </div> -->
            </div>
            <!-- Card 1 - End -->

            <!-- Card 2 - Start -->
            <div data-card="2" class="hidden">
                <div class="row mb-3">
                    <div>
                        <label for="description" class="form-label">Brief Description</label>
                        <textarea name="school[description]" type="text" class="form-control" id="description" row="3" placeholder="e.g. English friendly preschool with own playground in the quiet neighborhood of Prague"><%= school.description %></textarea>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="price" class="form-label">Tuition Fees <strong>per day</strong>(approximate)</label>
                    <div class="input-group">
                        <input required name="school[price][value]" type="number" min="0" step="0.10" class="form-control" id="price" placeholder="e.g. 6.98" value="<%= school.price.value %>">  
                        <select name="school[price][currency]" data-currency="<%= school.price.currency %>" id="currencyList" class="form-select">
                            <option value="USD" selected="selected" label="US dollar">USD</option>
                            <option value="EUR" label="Euro">EUR</option>
                            <option value="JPY" label="Japanese yen">JPY</option>
                            <option value="GBP" label="Pound sterling">GBP</option>
                            <option disabled>──────────</option>
                            <!-- <option value="AED" label="United Arab Emirates dirham">AED</option>
                            <option value="AFN" label="Afghan afghani">AFN</option>
                            <option value="ALL" label="Albanian lek">ALL</option>
                            <option value="AMD" label="Armenian dram">AMD</option>
                            <option value="ANG" label="Netherlands Antillean guilder">ANG</option>
                            <option value="AOA" label="Angolan kwanza">AOA</option> -->
                            <!-- <option value="ARS" label="Argentine peso">ARS</option> -->
                            <option value="AUD" label="Australian dollar">AUD</option>
                            <!-- <option value="AWG" label="Aruban florin">AWG</option>
                            <option value="AZN" label="Azerbaijani manat">AZN</option> -->
                            <!-- <option value="BAM" label="Bosnia and Herzegovina convertible mark">BAM</option> -->
                            <!-- <option value="BBD" label="Barbadian dollar">BBD</option> -->
                            <!-- <option value="BDT" label="Bangladeshi taka">BDT</option>
                            <option value="BGN" label="Bulgarian lev">BGN</option>
                            <option value="BHD" label="Bahraini dinar">BHD</option> -->
                            <!-- <option value="BIF" label="Burundian franc">BIF</option> -->
                            <!-- <option value="BMD" label="Bermudian dollar">BMD</option> -->
                            <!-- <option value="BND" label="Brunei dollar">BND</option> -->
                            <!-- <option value="BOB" label="Bolivian boliviano">BOB</option> -->
                            <!-- <option value="BRL" label="Brazilian real">BRL</option>
                            <option value="BSD" label="Bahamian dollar">BSD</option>
                            <option value="BTN" label="Bhutanese ngultrum">BTN</option>
                            <option value="BWP" label="Botswana pula">BWP</option>
                            <option value="BYN" label="Belarusian ruble">BYN</option>
                            <option value="BZD" label="Belize dollar">BZD</option> -->
                            <option value="CAD" label="Canadian dollar">CAD</option>
                            <!-- <option value="CDF" label="Congolese franc">CDF</option> -->
                            <option value="CHF" label="Swiss franc">CHF</option>
                            <!-- <option value="CLP" label="Chilean peso">CLP</option> -->
                            <option value="CNY" label="Chinese yuan">CNY</option>
                            <!-- <option value="COP" label="Colombian peso">COP</option> -->
                            <!-- <option value="CRC" label="Costa Rican colón">CRC</option> -->
                            <!-- <option value="CUC" label="Cuban convertible peso">CUC</option> -->
                            <!-- <option value="CUP" label="Cuban peso">CUP</option> -->
                            <!-- <option value="CVE" label="Cape Verdean escudo">CVE</option> -->
                            <option value="CZK" label="Czech koruna">CZK</option>
                            <!-- <option value="DJF" label="Djiboutian franc">DJF</option> -->
                            <option value="DKK" label="Danish krone">DKK</option>
                            <!-- <option value="DOP" label="Dominican peso">DOP</option> -->
                            <!-- <option value="DZD" label="Algerian dinar">DZD</option> -->
                            <!-- <option value="EGP" label="Egyptian pound">EGP</option> -->
                            <!-- <option value="ERN" label="Eritrean nakfa">ERN</option> -->
                            <!-- <option value="ETB" label="Ethiopian birr">ETB</option> -->
                            <!-- <option value="EUR" label="EURO">EUR</option> -->
                            <!-- <option value="FJD" label="Fijian dollar">FJD</option> -->
                            <!-- <option value="FKP" label="Falkland Islands pound">FKP</option> -->
                            <option value="GBP" label="British pound">GBP</option>
                            <!-- <option value="GEL" label="Georgian lari">GEL</option> -->
                            <!-- <option value="GGP" label="Guernsey pound">GGP</option> -->
                            <!-- <option value="GHS" label="Ghanaian cedi">GHS</option> -->
                            <!-- <option value="GIP" label="Gibraltar pound">GIP</option> -->
                            <!-- <option value="GMD" label="Gambian dalasi">GMD</option> -->
                            <!-- <option value="GNF" label="Guinean franc">GNF</option>
                            <option value="GTQ" label="Guatemalan quetzal">GTQ</option>
                            <option value="GYD" label="Guyanese dollar">GYD</option> -->
                            <option value="HKD" label="Hong Kong dollar">HKD</option>
                            <!-- <option value="HNL" label="Honduran lempira">HNL</option> -->
                            <!-- <option value="HRK" label="Croatian kuna">HRK</option> -->
                            <!-- <option value="HTG" label="Haitian gourde">HTG</option>
                            <option value="HUF" label="Hungarian forint">HUF</option> -->
                            <!-- <option value="IDR" label="Indonesian rupiah">IDR</option> -->
                            <option value="ILS" label="Israeli new shekel">ILS</option>
                            <!-- <option value="IMP" label="Manx pound">IMP</option>
                            <option value="INR" label="Indian rupee">INR</option>
                            <option value="IQD" label="Iraqi dinar">IQD</option>
                            <option value="IRR" label="Iranian rial">IRR</option> -->
                            <option value="ISK" label="Icelandic króna">ISK</option>
                            <!-- <option value="JEP" label="Jersey pound">JEP</option>
                            <option value="JMD" label="Jamaican dollar">JMD</option>
                            <option value="JOD" label="Jordanian dinar">JOD</option> -->
                            <option value="JPY" label="Japanese yen">JPY</option>
                            <!-- <option value="KES" label="Kenyan shilling">KES</option>
                            <option value="KGS" label="Kyrgyzstani som">KGS</option>
                            <option value="KHR" label="Cambodian riel">KHR</option>
                            <option value="KID" label="Kiribati dollar">KID</option>
                            <option value="KMF" label="Comorian franc">KMF</option>
                            <option value="KPW" label="North Korean won">KPW</option> -->
                            <option value="KRW" label="South Korean won">KRW</option>
                            <!-- <option value="KWD" label="Kuwaiti dinar">KWD</option>
                            <option value="KYD" label="Cayman Islands dollar">KYD</option>
                            <option value="KZT" label="Kazakhstani tenge">KZT</option>
                            <option value="LAK" label="Lao kip">LAK</option>
                            <option value="LBP" label="Lebanese pound">LBP</option>
                            <option value="LKR" label="Sri Lankan rupee">LKR</option>
                            <option value="LRD" label="Liberian dollar">LRD</option>
                            <option value="LSL" label="Lesotho loti">LSL</option>
                            <option value="LYD" label="Libyan dinar">LYD</option>
                            <option value="MAD" label="Moroccan dirham">MAD</option>
                            <option value="MDL" label="Moldovan leu">MDL</option>
                            <option value="MGA" label="Malagasy ariary">MGA</option>
                            <option value="MKD" label="Macedonian denar">MKD</option>
                            <option value="MMK" label="Burmese kyat">MMK</option>
                            <option value="MNT" label="Mongolian tögrög">MNT</option>
                            <option value="MOP" label="Macanese pataca">MOP</option>
                            <option value="MRU" label="Mauritanian ouguiya">MRU</option>
                            <option value="MUR" label="Mauritian rupee">MUR</option>
                            <option value="MVR" label="Maldivian rufiyaa">MVR</option>
                            <option value="MWK" label="Malawian kwacha">MWK</option>
                            <option value="MXN" label="Mexican peso">MXN</option> -->
                            <option value="MYR" label="Malaysian ringgit">MYR</option>
                            <!-- <option value="MZN" label="Mozambican metical">MZN</option>
                            <option value="NAD" label="Namibian dollar">NAD</option>
                            <option value="NGN" label="Nigerian naira">NGN</option>
                            <option value="NIO" label="Nicaraguan córdoba">NIO</option>
                            <option value="NOK" label="Norwegian krone">NOK</option>
                            <option value="NPR" label="Nepalese rupee">NPR</option> -->
                            <option value="NZD" label="New Zealand dollar">NZD</option>
                            <!-- <option value="OMR" label="Omani rial">OMR</option>
                            <option value="PAB" label="Panamanian balboa">PAB</option>
                            <option value="PEN" label="Peruvian sol">PEN</option>
                            <option value="PGK" label="Papua New Guinean kina">PGK</option>
                            <option value="PHP" label="Philippine peso">PHP</option>
                            <option value="PKR" label="Pakistani rupee">PKR</option> -->
                            <option value="PLN" label="Polish złoty">PLN</option>
                            <!-- <option value="PRB" label="Transnistrian ruble">PRB</option>
                            <option value="PYG" label="Paraguayan guaraní">PYG</option> -->
                            <option value="QAR" label="Qatari riyal">QAR</option>
                            <!-- <option value="RON" label="Romanian leu">RON</option>
                            <option value="RSD" label="Serbian dinar">RSD</option>
                            <option value="RUB" label="Russian ruble">RUB</option>
                            <option value="RWF" label="Rwandan franc">RWF</option>
                            <option value="SAR" label="Saudi riyal">SAR</option> -->
                            <option value="SEK" label="Swedish krona">SEK</option>
                            <option value="SGD" label="Singapore dollar">SGD</option>
                            <!-- <option value="SHP" label="Saint Helena pound">SHP</option>
                            <option value="SLL" label="Sierra Leonean leone">SLL</option>
                            <option value="SLS" label="Somaliland shilling">SLS</option>
                            <option value="SOS" label="Somali shilling">SOS</option>
                            <option value="SRD" label="Surinamese dollar">SRD</option>
                            <option value="SSP" label="South Sudanese pound">SSP</option>
                            <option value="STN" label="São Tomé and Príncipe dobra">STN</option>
                            <option value="SYP" label="Syrian pound">SYP</option>
                            <option value="SZL" label="Swazi lilangeni">SZL</option>
                            <option value="THB" label="Thai baht">THB</option>
                            <option value="TJS" label="Tajikistani somoni">TJS</option>
                            <option value="TMT" label="Turkmenistan manat">TMT</option>
                            <option value="TND" label="Tunisian dinar">TND</option>
                            <option value="TOP" label="Tongan paʻanga">TOP</option>
                            <option value="TRY" label="Turkish lira">TRY</option>
                            <option value="TTD" label="Trinidad and Tobago dollar">TTD</option>
                            <option value="TVD" label="Tuvaluan dollar">TVD</option> -->
                            <option value="TWD" label="New Taiwan dollar">TWD</option>
                            <!-- <option value="TZS" label="Tanzanian shilling">TZS</option>
                            <option value="UAH" label="Ukrainian hryvnia">UAH</option>
                            <option value="UGX" label="Ugandan shilling">UGX</option> -->
                            <!-- <option value="USD" label="United States dollar">USD</option> -->
                            <!-- <option value="UYU" label="Uruguayan peso">UYU</option>
                            <option value="UZS" label="Uzbekistani soʻm">UZS</option>
                            <option value="VES" label="Venezuelan bolívar soberano">VES</option> -->
                            <!-- <option value="VND" label="Vietnamese đồng">VND</option> -->
                            <!-- <option value="VUV" label="Vanuatu vatu">VUV</option>
                            <option value="WST" label="Samoan tālā">WST</option>
                            <option value="XAF" label="Central African CFA franc">XAF</option>
                            <option value="XCD" label="Eastern Caribbean dollar">XCD</option>
                            <option value="XOF" label="West African CFA franc">XOF</option>
                            <option value="XPF" label="CFP franc">XPF</option>
                            <option value="ZAR" label="South African rand">ZAR</option>
                            <option value="ZMW" label="Zambian kwacha">ZMW</option>
                            <option value="ZWB" label="Zimbabwean bonds">ZWB</option> -->
                        </select>
                    </div>
                    <small class="pt-1">Select your <strong>local currency</strong> or currency that is mainly used in your area</small>
                </div>
                
                <div class="pt-2 mb-3">
                    <h5>Amenities & Features</h5>
                    <div>
                        <% for (const amenity of amenities) { %> 
                            <input type="checkbox" class="btn-check" name="school[amenities]" <%= school.amenities.indexOf(amenity.name) >= 0 ? 'checked' : '' %> value="<%= amenity.name %>" id="<%= amenity.name %>" autocomplete="off">
                            <label class="btn btn-outline-secondary mt-1" for="<%= amenity.name %>"><%= amenity.name %></label> 
                            <% } %>
                    </div>
                </div>

                <!-- <div class="pt-2 mb-3">
                    <h5>Cover image</h5>
                    <div class="col-6">
                        <div class="input-group mb-3">
                            <input type="file" class="form-control" id="inputGroupFile02">
                        </div>
                    </div>
                </div> -->
                    
                
            </div>
            <!-- Card 2 - End -->
            
            <!-- Submit button -->
            <div class="mb-3 d-grid">
                <button type="submit" class="btn btn-primary">Update</button>
            </div>
            <!-- 
            <div class="d-grid mb-3">
                <button type="submit" class="btn btn-primary">Submit</button>
            </div> -->
        </form>
    </div>
</div>


<!-- <script src="/js/form.js"></script> -->

<script>

        // Select current country from the dropdown
        const countryOptions = document.querySelectorAll('#country option')
        const countryInput = document.querySelector('#country');
        for (const c of countryOptions) {
            if (c.value == countryInput.dataset.countryCode) {
                c.selected = true;
            }
        }

        // Select currency
        const currencyOptions = document.querySelectorAll('#currencyList option');
        const currencyInput = document.querySelector('#currencyList');
        for (const cur of currencyOptions) {
            if (cur.value === currencyInput.dataset.currency) {
                cur.selected = true;
            }
        }


</script>


<script>
    const geocoderCityContainer = document.getElementById('geocoder-city');
    const geocoderAddressContainer = document.getElementById('geocoder-address');
    mapboxgl.accessToken = '<%- process.env.MAPBOX_TOKEN %>'

    const currentCoordinates = document.querySelector('#_coordinates').value;
    const coordinatesArray = currentCoordinates.split(',').map(Number);
    // console.log(coordinatesArray)

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11', // style URL
        center: coordinatesArray, // starting position [lng, lat]
        zoom: 16 // starting zoom
    });


    // create geocoder
    const geocoderCity = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        countries: countryInput.dataset.countryCode,
        types: 'place'
    })

    // get city bbox from database and convert it from string back to array
    const bboxField = document.getElementById('_bbox').value;
    const bbox = bboxField.split(',').map(Number);
    // console.log(bbox)

    const geocoderStreet = new MapboxGeocoder({ 
        accessToken: mapboxgl.accessToken,
        bbox: bbox,
        types: 'address'
    });
    // const marker = new mapboxgl.Marker();

    geocoderCity.addTo('#geocoder-city');
    geocoderStreet.addTo('#geocoder-address');

    geocoderStreet.on('result', (e) => {
        addressGeocoder(e);
    })

    // Set values from database on page load
    let mockupInputAddress = document.querySelector('#geocoder-address .mapboxgl-ctrl-geocoder--input');
    mockupInputAddress.value = document.getElementById('_fullAddress').value;
    mockupInputAddress.parentElement.style.width = '100%';
    mockupInputAddress.parentElement.style.maxWidth = '100%';

    // Input mockup
    const mockupInputCity = document.querySelector('#geocoder-city .mapboxgl-ctrl-geocoder--input');
    mockupInputCity.disabled = false;
    mockupInputCity.parentElement.style.width = '100%';
    mockupInputCity.style.maxWidth = '100%';
    // mockupInputCity.parentElement.style.opacity = '50%';
    mockupInputCity.value = document.getElementById('_city').value;

    function mockupAddress() {
        const mockupInputAddress = document.querySelector('#geocoder-address .mapboxgl-ctrl-geocoder--input');
        mockupInputAddress.disabled = true;
        mockupInputAddress.parentElement.style.width = '100%';
        mockupInputAddress.parentElement.style.maxWidth = '100%';
        mockupInputAddress.parentElement.style.opacity = '50%';
        mockupInputAddress.value = "";
    }
    // mockupAddress()

    const marker = new mapboxgl.Marker()
        .setLngLat(coordinatesArray)
        .addTo(map);

    // CHANGE OF CITY ONLY
    geocoderCity.on('result', (e) => {
        
        // get the bounding box of the selected city
        let bbox = e.result.bbox;

        // City - update hidden field
        document.querySelector('#_city').value = e.result.text;
        console.log(e.result.text)

        // add bbox to hidden field to save to database for future use
        // convert to string first so it can be added into input
        document.querySelector('#_bbox').value = bbox.join();

        // Update input with City center coordinates
        document.querySelector('#_cityCenterCoords').value = e.result.center;

        // remove previous geocoder search bar if there's any
        if (geocoderAddressContainer.firstChild != null) {
            geocoderAddressContainer.innerHTML = '';
        }

        const geocoderAddress = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            bbox: bbox,
            types: 'address',
            mapboxgl: mapboxgl
        })

        geocoderAddress.addTo('#geocoder-address');

        // ADDRESS GEOCODER CUSTOM CSS
        const geocoderAddonAddress = geocoderAddressContainer.firstChild;
        geocoderAddonAddress.style.width = '100%';
        geocoderAddonAddress.style.maxWidth = '100%';

        geocoderAddress.on('result', (e) => {
            addressGeocoder(e)
        });

        // alert('city changed')
        // map.flyTo({center: e.result.geometry.coordinates })
        // marker.setLngLat(e.result.geometry.coordinates).addTo(map)
    });

    // CHANGE OF ADDRESS ONLY
    // geocoderAddress.on('result', (e) => {   
    //     addressGeocoder(e)
    // });



    // GEOCODER - create real search bar AFTER COUNTRY IS SELECTED
    const optGroups = document.querySelectorAll('optgroup');
    countryInput.addEventListener('change', (e) => {
        mockupAddress()
        // remove previous geocoder search bar if there's any
        if (geocoderCityContainer.firstChild != null) {
            geocoderCityContainer.innerHTML = '';
        }

        // Select continent and update field
        const optGroups = document.querySelectorAll('optgroup');
        for (const group of optGroups) {
            for (const option of group.children) {
                if (option.value === e.target.value) {
                    const continent = document.querySelector('#_continent');
                    continent.value = group.label;
                }
            }
        }

        // create geocoder
        const geocoderCity = new MapboxGeocoder({ 
            accessToken: mapboxgl.accessToken,
            countries: e.target.value,
            types: 'place'
            // mapboxgl: mapboxgl,
        });

        // Attach Geocoder to my html element 
        geocoderCity.addTo('#geocoder-city');

        // CITY GEOCODER CUSTOM CSS
        const geocoderAddon = geocoderCityContainer.firstChild;
        geocoderAddon.style.width = '100%';
        geocoderAddon.style.maxWidth = '100%';
    
        geocoderCity.on('result', (e) => {
            // console.log(e.result)

            // get the bounding box of the selected city
            let bbox = e.result.bbox;

            // add bbox to hidden field to save to database for future use
            // convert to string first so it can be added into input
            document.querySelector('#_bbox').value = bbox.join();

            // Update input with City center coordinates
            document.querySelector('#_cityCenterCoords').value = e.result.center;

            // remove previous geocoder search bar if there's any
            if (geocoderAddressContainer.firstChild != null) {
                geocoderAddressContainer.innerHTML = '';
            }

            const geocoderAddress = new MapboxGeocoder({
                accessToken: mapboxgl.accessToken,
                bbox: bbox,
                types: 'address',
                mapboxgl: mapboxgl
            })

            geocoderAddress.addTo('#geocoder-address');

            // ADDRESS GEOCODER CUSTOM CSS
            const geocoderAddonAddress = geocoderAddressContainer.firstChild;
            geocoderAddonAddress.style.width = '100%';
            geocoderAddonAddress.style.maxWidth = '100%';

            // ADDRESS geocoder -- START
            geocoderAddress.on('result', (e) => {
                addressGeocoder(e)
            });
        })

        // Clear address bar and add back mockup on CITY clear
        geocoderCity.on('clear', () => {
            const inp = document.querySelector('#geocoder-address');
            inp.innerHTML = '';
            geocoderStreet.addTo('#geocoder-address');
            mockupAddress()
        });
    })

    function addressGeocoder(e) {
        // console.log(e.result)
        marker.setLngLat(e.result.geometry.coordinates).addTo(map)

        document.querySelector('#_coordinates').value = e.result.geometry.coordinates;

        // Full Address, Street Name & Number
        document.querySelector('#_fullAddress').value = e.result.place_name; 
        document.querySelector('#_streetName').value = e.result.text;
        document.querySelector('#_streetNumber').value = e.result.address;

        for (const result of e.result.context) {
            // City
            if (result.id.match("place")) {
                document.querySelector('#_city').value = result.text;
            }

            // Country
            if (result.id.match("country")) {
                document.querySelector('#_countryName').value = result.text;
            }

            // Postcode
            if (result.id.match("postcode")) {
                document.querySelector('#_zip').value = result.text;
            }

            // State / Province e.g.Maine
            if (result.id.match("region")) {
                document.querySelector('#_region').value = result.text;
            }

            // County e.g.Washington County
            if (result.id.match("district")) {
                document.querySelector('#_district').value = result.text;
            }

            // Borough e.g.Brooklyn
            if (result.id.match("locality")) {
                document.querySelector('#_locality').value = result.text;
            }

            // Borough e.g.Venice Beach
            if (result.id.match("neighborhood")) {
                document.querySelector('#_neighborhood').value = result.text;
            }
        }

        map.flyTo({
            center: e.result.center,
            zoom: 16
        })
        // ADDRESS geocoder -- END
    }
        

</script>

<script>
    const tab1 = document.querySelector('#tab1');
    const tab2 = document.querySelector('#tab2');
    // const nextBtn = document.querySelector('.next-step');
    // const backBtn = document.querySelector('.back-button');
    const card1 = document.querySelector("[data-card='1']");
    const card2 = document.querySelector("[data-card='2']");
    // const step1 = document.querySelector('#step-1');
    // const step2 = document.querySelector('#step-2');

    tab2.addEventListener('click', () => {
        card1.classList.add('hidden')
        card2.classList.remove('hidden');
        tab2.classList.add('active')
        tab1.classList.remove('active')
    });

    tab1.addEventListener('click', () => {
        card2.classList.add('hidden')
        card1.classList.remove('hidden');
        tab1.classList.add('active')
        tab2.classList.remove('active')
    })
</script>        


   

